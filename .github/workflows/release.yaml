name: Build Release

on:
  push:
    tags:
      - 'v*'  # 只在推送 v 开头的 tag 时触发
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.5'

      - name: Build all platforms
        run: |
          # 定义构建目标
          targets=(
            "linux/amd64"
            "linux/arm64"
            "linux/arm"
            "linux/s390x"
            "linux/riscv64"
            "windows/amd64"
            "windows/arm64"
            "darwin/amd64"
            "darwin/arm64"
            "freebsd/amd64"
          )
          
          # 记录失败的构建
          failed_builds=()
          successful_builds=()
          
          # 批量构建（带错误处理）
          for target in "${targets[@]}"; do
            GOOS=${target%/*}
            GOARCH=${target#*/}
            output="gopanel_${GOOS}_${GOARCH}"
            [ "$GOOS" = "windows" ] && output="${output}.exe"
            [ "$GOOS" = "darwin" ] && output="gopanel_mac_${GOARCH}"
            
            echo "Building $output..."
            if CGO_ENABLED=0 GOOS=$GOOS GOARCH=$GOARCH go build -o $output 2>&1; then
              echo "✅ Successfully built $output"
              successful_builds+=("$output")
            else
              echo "❌ Failed to build $output"
              failed_builds+=("$target")
            fi
          done
          
          # 输出构建摘要
          echo ""
          echo "========== Build Summary =========="
          if [ ${#successful_builds[@]} -gt 0 ]; then
            echo "✅ Successful builds (${#successful_builds[@]}):"
            for build in "${successful_builds[@]}"; do
              echo "   - $build"
            done
          fi
          
          if [ ${#failed_builds[@]} -gt 0 ]; then
            echo ""
            echo "❌ Failed builds (${#failed_builds[@]}):"
            for build in "${failed_builds[@]}"; do
              echo "   - $build"
            done
          fi
          echo "==================================="
          
          # 如果没有任何成功的构建，则失败
          if [ ${#successful_builds[@]} -eq 0 ]; then
            echo "❌ All builds failed!"
            exit 1
          fi
          
          # 如果有失败的构建，输出警告但不中断流程
          if [ ${#failed_builds[@]} -gt 0 ]; then
            echo "⚠️ Some builds failed, but will proceed with successful ones"
          fi

      - name: List built files
        run: |
          echo "Files to be released:"
          ls -lh gopanel_* 2>/dev/null || echo "No files found"
      
      - name: Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: gopanel_*
          fail_on_unmatched_files: false  # 不因找不到文件而失败
