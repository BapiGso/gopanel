{{template "header.template"}}
<div id="editorParent" :style="editorShow && {visibility: 'visible'} || {visibility: 'hidden'}">
    <script type="text/javascript" src="/assets/js/ace.js"></script>
    <div style="background-color: cadetblue;width: 80%">
        <button @click.prevent="updateFile('update',editor.filename,editor.getSession().getValue())" style="float: left">Save</button>
        <button @click="editorShow=false" style="float: right">Ã—</button>
    </div>
    <div id="editor"></div>
</div>
<section>
    <p>
        <div x-ref="element"></div>
        <button @click="homeHistory">ğŸ Home</button>
        <button @click="backHistory">ğŸ”™Back</button>
        <input type="text" x-bind="inputHistory">
    </p>
    <p>
        <input type="file" @change="uploadFiles($el)" multiple name="files">
        For complex file management, please use the <button @click="location.href='/admin/webdav'">webdav</button> function
    </p>
    <table>
        <thead>
        <tr>
            <th>
                <input type="checkbox" x-model="checkAll">
            </th>
            <th>åç§°</th>
            <th>æƒé™</th>
            <th>å¤§å°</th>
            <th>ä¿®æ”¹æ—¶é—´</th>
            <th>æ“ä½œ</th>
        </tr>
        </thead>
        <tbody>
        {{range .}}
            <tr>
                <td>
                    <input type="checkbox" x-init="$watch('checkAll', val => $el.checked=val)">
                </td>
                <td>
                    {{if .IsDir}}
                        ğŸ“<a @click="changeDirectory($el.innerText)">{{.Name}}</a>
                    {{else}}
                        ğŸ“„{{.Name}}
                    {{end}}
                </td>
                <td>{{.Mode.Perm}}</td>
                <td x-text="formatBytes(`{{.Size}}`)"></td>
                <td>{{.ModTime.Format "2006-01-02 15:04:05"}}</td>
                <td @focus="$el.style.color='black'" @blur="$el.style.color='transparent'" style="color: transparent">
                    {{if .IsDir}}
                        | <a @click.prevent="changeDirectory(`{{.Name}}`)">Open</a>
                    {{else}}
                        | <a @click.prevent="newEditor(`{{.Name}}`)">Edit</a>
                        | <a x-init="$el.href=`/admin/file/process?path=${getDirectoryValue()}/{{.Name}}`">Download</a>
                    {{end}}
                        | <a @click.prevent="updateFile('rename', `{{.Name}}`,prompt('rename', `{{.Name}}`))">Rename</a>
                        | <a @click.prevent="updateFile('PMSN', `{{.Name}}`,prompt('set PMSN eg:0644', ''))">PMSN</a>
                        | <a @click.prevent="deleteFile(`{{.Name}}`)">Delete</a>
                </td>
            </tr>
        {{end}}
        </tbody>
    </table>

</section>
<script>
    document.addEventListener('alpine:init', () => {
            Alpine.data('panel', () => ({
                formatBytes(bytes, decimals = 2) {
                    if (bytes === '0') return '0';
                    const k = 1024;
                    const dm = decimals < 0 ? 0 : decimals;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
                },
                checkAll: false,
                getDirectoryValue: function () {
                    let directoryValue;
                    document.cookie.split(";").forEach((cookie) => {
                        let val = cookie.split('=')
                        if (val[0] === 'dirHistory') {
                            directoryValue = val[1];
                        }
                    });
                    return directoryValue;
                },
                inputHistory: {
                    'x-ref': 'inputHistory',
                    'x-init'() {
                        this.$refs.inputHistory.style = 'width:inherit'
                        this.$refs.inputHistory.value = `${this.getDirectoryValue()}`
                    },
                    //å¤±ç„¦äº‹ä»¶
                    '@blur'() {
                        document.cookie = `dirHistory=${this.$refs.inputHistory.value}`
                        location.reload()
                    }
                },
                changeDirectory: function (name) {
                    document.cookie = `dirHistory=${this.getDirectoryValue()}/${name}`
                    location.reload()
                },
                homeHistory: function () {
                    document.cookie = `dirHistory=/`
                    location.reload()
                },
                backHistory: function () {
                    let i = this.getDirectoryValue().lastIndexOf('/')
                    document.cookie = `dirHistory=${this.getDirectoryValue().substring(0, i)}`
                    if (i === 0) this.homeHistory();//å¦‚æœä¸Šä¸€å±‚æ˜¯ä¸»é¡µåˆ™è°ƒç”¨è¿”å›ä¸»é¡µ
                    location.reload()
                },
                editorShow: false,
                newEditor: async function (name) {
                    const res = await fetch(`/admin/file/process?path=${this.getDirectoryValue()}/${name}&mode=edit`);
                    if (res.status !== 200) {
                        alert(await res.text());
                    } else {
                        await res.json().then(data => {
                            window.editor = ace.edit("editor");
                            editor.setValue(data.data, -1);
                            editor.filename = name;
                            editor.session.setMode(`ace/mode/${data.type}`);
                            this.editorShow = true;
                        });
                    }
                },
                uploadFiles: function (el) {
                    let formData = new FormData();
                    for (let i = 0; i < el.files.length; i++) {
                        formData.append('files', el.files[i])
                    }
                    fetch(`/admin/file/process?path=${this.getDirectoryValue()}`, {
                        method: 'POST',
                        body: formData
                    })
                        .then(res => res.text())
                        .then(data => {
                            alert(data);
                            location.reload()
                        })
                },
                updateFile: function (type,name,data) {
                    if(!data)return
                    if (type==='rename')data=`${this.getDirectoryValue()}/${data}`
                    fetch(`/admin/file/process?path=${this.getDirectoryValue()}/${name}&mode=${type}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'text/plain', },// æˆ–è€…ä½ çš„æ–‡ä»¶å†…å®¹çš„å®é™…MIMEç±»å‹
                        body: data
                    })
                        .then(response => response.text())
                        .then(data => alert(data))
                },
                deleteFile: function (name) {
                    if (confirm("sure to delete?")) {
                        fetch(`/admin/file/process?path=${this.getDirectoryValue()}/${name}`, {
                            method: 'DELETE'
                        })
                            .then(res => res.text())
                            .then(data => alert(data))
                    }
                },

                })
            )
        }
    )
</script>