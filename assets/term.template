{{template "header.template"}}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <div>
            <h3 class="text-2xl font-bold text-gray-900 dark:text-white tracking-tight flex items-center">
                <i class="ri-terminal-box-line text-blue-600 dark:text-blue-400 mr-3"></i>
                Web Terminal
            </h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 ml-9">Connect and manage your server via SSH</p>
        </div>
    </div>

    <!-- Connection Panel -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-6 mb-6" x-data="{ showForm: !localStorage.host }">
        <div class="flex items-center justify-between mb-4 cursor-pointer" @click="showForm = !showForm">
            <h4 class="text-base font-semibold text-gray-900 dark:text-white flex items-center">
                <i class="ri-server-line mr-2 text-gray-400"></i>
                SSH Connection Details
            </h4>
            <i class="ri-arrow-down-s-line text-gray-400 transition-transform duration-200" :class="{'rotate-180': showForm}"></i>
        </div>

        <div x-show="showForm" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 -translate-y-2" x-transition:enter-end="opacity-100 translate-y-0">
            <form action="" method="post" @submit.prevent="createSSH" x-init="memorySSH($el)">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5">
                    <div class="space-y-1.5">
                        <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Host</label>
                        <div class="relative">
                            <i class="ri-global-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input name="host" type="text" placeholder="127.0.0.1" value="127.0.0.1" required
                                   class="w-full pl-9 pr-3 py-2 border border-gray-200 dark:border-gray-600 rounded-xl bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-sm font-mono">
                        </div>
                    </div>

                    <div class="space-y-1.5">
                        <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Port</label>
                        <div class="relative">
                            <i class="ri-door-lock-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input name="port" type="number" placeholder="22" value="22" required
                                   class="w-full pl-9 pr-3 py-2 border border-gray-200 dark:border-gray-600 rounded-xl bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-sm font-mono">
                        </div>
                    </div>

                    <div class="space-y-1.5">
                        <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Username</label>
                        <div class="relative">
                            <i class="ri-user-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input name="user" type="text" placeholder="root" value="root" required
                                   class="w-full pl-9 pr-3 py-2 border border-gray-200 dark:border-gray-600 rounded-xl bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-sm font-mono">
                        </div>
                    </div>

                    <div class="space-y-1.5">
                        <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Password</label>
                        <div class="relative">
                            <i class="ri-key-2-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input name="pwd" type="password" placeholder="Optional"
                                   class="w-full pl-9 pr-3 py-2 border border-gray-200 dark:border-gray-600 rounded-xl bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-sm font-mono">
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex items-center gap-3 border-t border-gray-100 dark:border-gray-700 pt-4">
                    <button type='submit'
                            class="px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-md hover:shadow-lg transition-all flex items-center text-sm font-medium">
                        <i class="ri-plug-line mr-2 text-lg"></i>
                        Connect
                    </button>
                    <button type='button' @click.prevent="clearSavedConnection" x-show="localStorage.host"
                            class="px-5 py-2 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-all flex items-center text-sm font-medium">
                        <i class="ri-delete-bin-line mr-2 text-lg"></i>
                        Clear Saved
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Terminal Window -->
    <div class="bg-[#000000] rounded-xl overflow-hidden shadow-2xl border border-gray-800 dark:border-gray-700 flex flex-col h-[calc(100vh-350px)] min-h-[500px]">
        <!-- Mac-style Title Bar -->
        <div class="bg-[#1a1b1e] px-4 py-2.5 border-b border-gray-800 flex items-center justify-between select-none">
            <div class="flex items-center space-x-2">
                <div class="w-3 h-3 rounded-full bg-[#FF5F56] hover:bg-[#FF5F56]/80 transition-colors"></div>
                <div class="w-3 h-3 rounded-full bg-[#FFBD2E] hover:bg-[#FFBD2E]/80 transition-colors"></div>
                <div class="w-3 h-3 rounded-full bg-[#27C93F] hover:bg-[#27C93F]/80 transition-colors"></div>
            </div>
            <div class="text-xs text-gray-400 font-medium flex items-center">
                <i class="ri-terminal-line mr-2"></i>
                SSH Terminal
            </div>
            <div class="w-14"></div> <!-- Spacer for center alignment -->
        </div>

        <!-- Terminal Content -->
        <div id="terminal" class="flex-1 p-1 custom-scrollbar"></div>
    </div>
</div>

<link rel="stylesheet" href="/assets/css/xterm.css" />
<style>
    .custom-scrollbar .xterm-viewport::-webkit-scrollbar {
        width: 8px;
    }
    .custom-scrollbar .xterm-viewport::-webkit-scrollbar-track {
        background: #1a1b1e;
    }
    .custom-scrollbar .xterm-viewport::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 4px;
    }
    .custom-scrollbar .xterm-viewport::-webkit-scrollbar-thumb:hover {
        background: #444;
    }
</style>

<script src="/assets/js/xterm.js"></script>
<script src="/assets/js/xterm-addon-attach.js"></script>
<script src="/assets/js/xterm-addon-fit.js"></script>
<script src="/assets/js/xterm-addon-web-links.js"></script>
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('panel', () => ({
            terminalInstance: null,
            fitAddon: null,

            init() {
                window.debounce = function(f, timeout) {
                    let t;
                    return (...args) => {
                        clearTimeout(t);
                        t = setTimeout(() => { f.apply(this, args); }, timeout);
                    };
                }
            },

            memorySSH(el) {
                if (localStorage.host) {
                    el.host.value = localStorage.host;
                    el.port.value = localStorage.port;
                    el.user.value = localStorage.user;
                    el.pwd.value = localStorage.pwd;

                    // Only auto-connect if we have memory
                    fetch(el.action, {
                        method: 'POST',
                        body: new FormData(el)
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data && data.id) {
                                this.linkSSH(data.id);
                            }
                        })
                        .catch(error => {
                            console.error('Auto-connect failed:', error);
                        });
                }
            },

            linkSSH(id) {
                // Clean up previous terminal if exists
                if (this.terminalInstance) {
                    this.terminalInstance.dispose();
                    document.getElementById('terminal').innerHTML = '';
                }

                const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
                const wsUrl = `${protocol}${window.location.host}/admin/term/${id}/data`;

                const attachAddon = new AttachAddon.AttachAddon(
                    new WebSocket(wsUrl),
                    { bidirectional: true }
                );
                this.fitAddon = new FitAddon.FitAddon();
                const webLinksAddon = new WebLinksAddon.WebLinksAddon();

                this.terminalInstance = new Terminal({
                    fontFamily: "'JetBrains Mono', 'Fira Code', Menlo, monospace",
                    fontSize: 14,
                    theme: {
                        background: '#000000',
                        foreground: '#d4d4d4',
                        cursor: '#ffffff',
                        selection: 'rgba(255, 255, 255, 0.3)',
                        black: '#000000',
                        red: '#cd3131',
                        green: '#0dbc79',
                        yellow: '#e5e510',
                        blue: '#2472c8',
                        magenta: '#bc3fbc',
                        cyan: '#11a8cd',
                        white: '#e5e5e5',
                        brightBlack: '#666666',
                        brightRed: '#f14c4c',
                        brightGreen: '#23d18b',
                        brightYellow: '#f5f543',
                        brightBlue: '#3b8eea',
                        brightMagenta: '#d670d6',
                        brightCyan: '#29b8db',
                        brightWhite: '#e5e5e5'
                    },
                    cursorBlink: true,
                    cursorStyle: 'block',
                    scrollback: 5000, // Increased scrollback
                    allowTransparency: true
                });

                this.terminalInstance.loadAddon(webLinksAddon);
                this.terminalInstance.loadAddon(this.fitAddon);
                this.terminalInstance.loadAddon(attachAddon);
                this.terminalInstance.open(document.getElementById('terminal'));

                this.terminalInstance.onResize(({cols, rows}) => {
                    fetch(`/admin/term/resize?id=${id}&cols=${cols}&rows=${rows}`)
                        .then(resp => resp.json())
                        .then(result => console.log('Terminal resized:', cols, rows))
                        .catch(error => console.error('Resize failed:', error));
                });

                // Initial fit with a small delay to ensure container is rendered
                setTimeout(() => {
                    this.fitAddon.fit();
                    this.terminalInstance.focus();
                }, 100);

                window.addEventListener('resize', debounce(() => {
                    if (this.fitAddon) {
                        this.fitAddon.fit();
                        this.terminalInstance.focus();
                    }
                }, 250));
            },

            async createSSH(e) {
                try {
                    const btn = e.target.querySelector('button[type="submit"]');
                    const originalHtml = btn.innerHTML;
                    btn.innerHTML = '<i class="ri-loader-4-line animate-spin mr-2 text-lg"></i> Connecting...';
                    btn.disabled = true;

                    const res = await fetch(e.target.action, {
                        method: 'POST',
                        body: new FormData(e.target)
                    });

                    if (res.status === 400) {
                        alert(await res.text());
                        btn.innerHTML = originalHtml;
                        btn.disabled = false;
                        return;
                    }

                    const data = await res.json();

                    btn.innerHTML = originalHtml;
                    btn.disabled = false;

                    if (!data || !data.id) return;

                    // Save connection info
                    localStorage.host = e.target.host.value;
                    localStorage.port = e.target.port.value;
                    localStorage.user = e.target.user.value;
                    localStorage.pwd = e.target.pwd.value;

                    // Collapse form for better view
                    this.showForm = false;

                    this.linkSSH(data.id);
                } catch (error) {
                    alert('Connection failed: ' + error.message);
                    const btn = e.target.querySelector('button[type="submit"]');
                    btn.innerHTML = '<i class="ri-plug-line mr-2 text-lg"></i> Connect';
                    btn.disabled = false;
                }
            },

            clearSavedConnection() {
                if (confirm('Clear saved connection information?')) {
                    localStorage.removeItem('host');
                    localStorage.removeItem('port');
                    localStorage.removeItem('user');
                    localStorage.removeItem('pwd');
                    location.reload();
                }
            }
        }))
    })
</script>
{{template "footer.template"}}